<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.manage.cattle.dao.breed.BreedDao">
    <select id="listBreedFrozenSemen" resultType="com.manage.cattle.dto.breed.BreedFrozenSemenDTO">
        select
            t.id,t.createUser,t.createTime,t.updateUser,t.updateTime,
            t.frozenSemenCode,t.frozenSemenBreed,sf.value frozenSemenBreedValue,
            t.sexControl,t.color,t.fatherCode,t.motherCode
        from t_breed_frozen_semen t
        left join t_sys_config sf on sf.code='cattleBreed' and t.frozenSemenBreed=sf.key
        where 1=1
        <if test="frozenSemenCode!=null and frozenSemenCode!=''">
            and t.frozenSemenCode=#{frozenSemenCode}
        </if>
        <if test="frozenSemenBreed!=null and frozenSemenBreed!=''">
            and t.frozenSemenBreed=#{frozenSemenBreed}
        </if>
        <if test="sexControl!=null and sexControl!=''">
            and t.sexControl=#{sexControl}
        </if>
        <if test="color!=null and color!=''">
            and t.color like concat('%',#{color},'%')
        </if>
        <if test="fatherCode!=null and fatherCode!=''">
            and t.fatherCode=#{fatherCode}
        </if>
        <if test="motherCode!=null and motherCode!=''">
            and t.motherCode=#{motherCode}
        </if>
        order by sf.sort,t.frozenSemenCode
    </select>

    <select id="getBreedFrozenSemen" resultType="com.manage.cattle.dto.breed.BreedFrozenSemenDTO">
        select
            t.id,t.createUser,t.createTime,t.updateUser,t.updateTime,
            t.frozenSemenCode,t.frozenSemenBreed,sf.value frozenSemenBreedValue,
            t.sexControl,t.color,t.fatherCode,t.motherCode
        from t_breed_frozen_semen t
        left join t_sys_config sf on sf.code='cattleBreed' and t.frozenSemenBreed=sf.key
        where t.frozenSemenCode=#{frozenSemenCode}
    </select>

    <insert id="addBreedFrozenSemen">
        insert into t_breed_frozen_semen(createUser,createTime,updateUser,updateTime,
                                         frozenSemenCode,frozenSemenBreed,sexControl,
                                         color,fatherCode,motherCode)
        values (#{createUser},now(),#{updateUser},now(),
                #{frozenSemenCode},#{frozenSemenBreed},#{sexControl},
                #{color},#{fatherCode},#{motherCode})
    </insert>

    <update id="updateBreedFrozenSemen">
        update t_breed_frozen_semen
        set updateUser=#{updateUser},updateTime=now(),
            frozenSemenBreed=#{frozenSemenBreed},sexControl=#{sexControl},
            color=#{color},fatherCode=#{fatherCode},motherCode=#{motherCode}
        where frozenSemenCode=#{frozenSemenCode}
    </update>

    <delete id="delBreedFrozenSemen">
        delete from t_breed_frozen_semen
        where id in
        <foreach collection="list" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
    </delete>

    <select id="listRefFrozenSemenCode" resultType="string">
        select frozenSemenCode
        from t_breed_register
        where frozenSemenCode in
        (select frozenSemenCode from t_breed_frozen_semen
        where id in
        <foreach collection="list" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>)
    </select>

    <select id="listBreedRegister" resultType="com.manage.cattle.dto.breed.BreedRegisterDTO">
        select
            t.id,t.createUser,t.createTime,t.updateUser,t.updateTime,
            tz.farmCode,tf.farmName,tf.farmOwner,
            tz.farmZoneCode,tc.cattleCode,
            t.frozenSemenCode,fs.frozenSemenBreed,sf.value frozenSemenBreedValue,fs.sexControl,
            t.breedingDay,DATE_ADD(t.breedingDay, INTERVAL 60 DAY) firstCheckDay,
            DATE_ADD(t.breedingDay, INTERVAL 90 DAY) reCheckDay,
            DATE_ADD(t.breedingDay, INTERVAL 270 DAY) expectedDay,
            t.breedingMethod,sb.value breedingMethodValue,t.operateUser
        from t_breed_register t
        join t_cattle tc on t.cattleCode=tc.cattleCode
        join t_farm_zone tz on tc.farmZoneCode=tz.farmZoneCode
        join t_farm tf on tz.farmCode=tf.farmCode
        left join t_breed_frozen_semen fs on t.frozenSemenCode=fs.frozenSemenCode
        left join t_sys_config sf on sf.code='cattleBreed' and fs.frozenSemenBreed=sf.key
        left join t_sys_config sb on sb.code='breedingMethod' and t.breedingMethod=sb.key
        where 1=1
        <if test="farmCode!=null and farmCode!=''">
            and tf.farmCode=#{farmCode}
        </if>
        <if test="farmZoneCode!=null and farmZoneCode!=''">
            and tz.farmZoneCode=#{farmZoneCode}
        </if>
        <if test="cattleCode!=null and cattleCode!=''">
            and tc.cattleCode=#{cattleCode}
        </if>
        <if test="frozenSemenCode!=null and frozenSemenCode!=''">
            and t.frozenSemenCode=#{frozenSemenCode}
        </if>
        <if test="frozenSemenBreed!=null and frozenSemenBreed!=''">
            and fs.frozenSemenBreed=#{frozenSemenBreed}
        </if>
        <if test="breedingDayStart!=null and breedingDayStart!=''">
            and t.breedingDay &gt;= #{breedingDayStart}
        </if>
        <if test="breedingDayEnd!=null and breedingDayEnd!=''">
            and t.breedingDay &lt;= #{breedingDayEnd}
        </if>
        <if test="breedingMethod!=null and breedingMethod!=''">
            and t.breedingMethod=#{breedingMethod}
        </if>
        <if test="operateUser!=null and operateUser!=''">
            and t.operateUser=#{operateUser}
        </if>
        order by breedingDay desc,farmName,farmZoneCode,cattleCode
    </select>

    <select id="listLastBreedRegister" resultType="com.manage.cattle.dto.breed.BreedRegisterDTO">
        select
               t.cattleCode,
               t.breedingDay,
               DATE_ADD(t.breedingDay, INTERVAL 60 DAY) firstCheckDay,
               DATE_ADD(t.breedingDay, INTERVAL 90 DAY) reCheckDay,
               DATE_ADD(t.breedingDay, INTERVAL 270 DAY) expectedDay
        from
        (select cattleCode,max(breedingDay) breedingDay from t_breed_register
        where cattleCode in
        <foreach collection="list" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
        group by cattleCode) t
    </select>

    <insert id="addBreedRegister">
        insert into t_breed_register(createUser,createTime,updateUser,updateTime,
                                     cattleCode,frozenSemenCode,
                                     breedingDay,breedingMethod,operateUser)
        values
        <foreach collection="cattleCodeList" item="item" separator=",">
            (#{createUser},now(),#{updateUser},now(),
            #{item},#{frozenSemenCode},
            #{breedingDay},#{breedingMethod},#{operateUser})
        </foreach>
    </insert>

    <delete id="delBreedRegister">
        delete from t_breed_register
        where id in
        <foreach collection="list" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
    </delete>

    <select id="listBreedPregnancyCheck" resultType="com.manage.cattle.dto.breed.BreedPregnancyCheckDTO">
        select
            t.id,t.createUser,t.createTime,t.updateUser,t.updateTime,
            tz.farmCode,tf.farmName,tf.farmOwner,
            tz.farmZoneCode,tc.cattleCode,
            t.checkDay,t.checkUser,t.result,t.remark
        from t_breed_pregnancy_check t
        join t_cattle tc on t.cattleCode=tc.cattleCode
        join t_farm_zone tz on tc.farmZoneCode=tz.farmZoneCode
        join t_farm tf on tz.farmCode=tf.farmCode
        where 1=1
        <if test="farmCode!=null and farmCode!=''">
            and tf.farmCode=#{farmCode}
        </if>
        <if test="farmZoneCode!=null and farmZoneCode!=''">
            and tz.farmZoneCode#{farmZoneCode}
        </if>
        <if test="cattleCode!=null and cattleCode!=''">
            and tc.cattleCode=#{cattleCode}
        </if>
        <if test="checkDayStart!=null and checkDayStart!=''">
            and t.checkDay &gt;= #{checkDayStart}
        </if>
        <if test="checkDayEnd!=null and checkDayEnd!=''">
            and t.checkDay &lt;= #{checkDayEnd}
        </if>
        <if test="checkUser!=null and checkUser!=''">
            and t.checkUser=#{checkUser}
        </if>
        <if test="result!=null and result!=''">
            and t.result like concat('%',#{result},'%')
        </if>
        order by checkDay desc,farmName,farmZoneCode,cattleCode
    </select>

    <select id="listBreedPregnancyCheckByCattleCode" resultType="com.manage.cattle.dto.breed.BreedPregnancyCheckDTO">
        select
        t.id,t.createUser,t.createTime,t.updateUser,t.updateTime,
        tz.farmCode,tf.farmName,tf.farmOwner,
        tz.farmZoneCode,tc.cattleCode,
        t.checkDay,t.checkUser,t.result,t.remark
        from t_breed_pregnancy_check t
        join t_cattle tc on t.cattleCode=tc.cattleCode
        join t_farm_zone tz on tc.farmZoneCode=tz.farmZoneCode
        join t_farm tf on tz.farmCode=tf.farmCode
        where t.cattleCode in
        <foreach collection="list" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
        order by checkDay desc,farmName,farmZoneCode,cattleCode
    </select>

    <insert id="addBreedPregnancyCheck">
        insert into t_breed_pregnancy_check(createUser,createTime,updateUser,updateTime,
        cattleCode,checkDay,checkUser,result,remark)
        values
        <foreach collection="cattleCodeList" item="item" separator=",">
            (#{createUser},now(),#{updateUser},now(),
            #{item},#{checkDay},#{checkUser},#{result},#{remark})
        </foreach>
    </insert>

    <delete id="delBreedPregnancyCheck">
        delete from t_breed_pregnancy_check
        where id in
        <foreach collection="list" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
    </delete>

    <select id="listBreedPregnancyResult" resultType="com.manage.cattle.dto.breed.BreedPregnancyResultDTO">
        select
            t.id,t.createUser,t.createTime,t.updateUser,t.updateTime,
            tz.farmCode,tf.farmName,tf.farmOwner,
            tz.farmZoneCode,tc.cattleCode,
            t.resultDay,t.operaUser,t.result,t.remark,
            t.childFarmZoneCode,t.childCattleCode,t.breed,sb.value breedValue,
            t.sex,t.color,t.weight
        from t_breed_pregnancy_result t
        join t_cattle tc on t.cattleCode=tc.cattleCode
        join t_farm_zone tz on tc.farmZoneCode=tz.farmZoneCode
        join t_farm tf on tz.farmCode=tf.farmCode
        left join t_sys_config sb on sb.code='cattleBreed' and t.breed=sb.key
        where 1=1
        <if test="farmCode!=null and farmCode!=''">
            and tf.farmCode=#{farmCode}
        </if>
        <if test="farmZoneCode!=null and farmZoneCode!=''">
            and tz.farmZoneCode=#{farmZoneCode}
        </if>
        <if test="cattleCode!=null and cattleCode!=''">
            and tc.cattleCode=#{cattleCode}
        </if>
        <if test="resultDayStart!=null and resultDayStart!=''">
            and t.resultDay &gt;= #{resultDayStart}
        </if>
        <if test="resultDayEnd!=null and resultDayEnd!=''">
            and t.resultDay &lt;= #{resultDayEnd}
        </if>
        <if test="operaUser!=null and operaUser!=''">
            and t.operaUser=#{operaUser}
        </if>
        <if test="result!=null and result!=''">
            and t.result=#{result}
        </if>
        <if test="remark!=null and remark!=''">
            and tc.remark like concat('%',#{remark},'%')
        </if>
        order by resultDay desc,farmName,farmZoneCode,cattleCode
    </select>

    <select id="listBreedPregnancyResultByCattleCode" resultType="com.manage.cattle.dto.breed.BreedPregnancyResultDTO">
        select
        t.id,t.createUser,t.createTime,t.updateUser,t.updateTime,
        tz.farmCode,tf.farmName,tf.farmOwner,
        tz.farmZoneCode,tc.cattleCode,
        t.resultDay,t.operaUser,t.result,t.remark,
        t.childFarmZoneCode,t.childCattleCode,t.breed,sb.value breedValue,
        t.sex,t.color,t.weight
        from t_breed_pregnancy_result t
        join t_cattle tc on t.cattleCode=tc.cattleCode
        join t_farm_zone tz on tc.farmZoneCode=tz.farmZoneCode
        join t_farm tf on tz.farmCode=tf.farmCode
        left join t_sys_config sb on sb.code='cattleBreed' and t.breed=sb.key
        where t.cattleCode in
        <foreach collection="list" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
        order by resultDay desc,farmName,farmZoneCode,cattleCode
    </select>

    <insert id="addBreedPregnancyResult">
        insert into t_breed_pregnancy_result(createUser,createTime,updateUser,updateTime,
                                             cattleCode,resultDay,operaUser,result,remark,
                                             childFarmZoneCode,childCattleCode,breed,sex,color,weight)
        values (#{createUser},now(),#{updateUser},now(),
                #{cattleCode},#{resultDay},#{operaUser},#{result},#{remark},
                #{childFarmZoneCode},#{childCattleCode},#{breed},#{sex},#{color},#{weight})
    </insert>

    <delete id="delBreedPregnancyResult">
        delete from t_breed_pregnancy_result
        where id in
        <foreach collection="list" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
    </delete>
</mapper>